language: php

env:
  global:
    - DEFAULT_COMPOSER_FLAGS="--prefer-dist --no-interaction --no-progress --optimize-autoloader"
    - TASK_STATIC_ANALYSIS=0
    - TASK_TESTS_COVERAGE=0

matrix:
  include:
    - php: "7.4"
      env:
        - TASK_STATIC_ANALYSIS=0 # set to 1 to enable static analysis
        - TASK_TESTS_COVERAGE=1

# faster builds on new travis setup not using sudo
sudo: false

# cache vendor dirs
cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - phpenv config-rm xdebug.ini || echo "xdebug is not installed"

install:
  - travis_retry composer self-update && composer --version
  - export PATH="$HOME/.composer/vendor/bin:$PATH"
  - travis_retry composer install $DEFAULT_COMPOSER_FLAGS
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      pecl install ast
    fi

before_script:
  - php --version
  - composer --version
  # enable code coverage
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
        PHPUNIT_COVERAGE_FLAG="--coverage-clover=coverage.clover"
    fi

script:
  - phpdbg -qrr vendor/bin/phpunit --verbose $PHPUNIT_COVERAGE_FLAG
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      composer phan
    fi
  - |
    if [ $TASK_STATIC_ANALYSIS == 1 ]; then
      cat analysis.txt
    fi

after_script:
  - |
    if [ $TASK_TESTS_COVERAGE == 1 ]; then
      travis_retry wget https://scrutinizer-ci.com/ocular.phar
      php ocular.phar code-coverage:upload --format=php-clover coverage.clover
    fi


notifications:
  slack:
    -
      rooms:
        -
          secure: q4xGUR1+rqoqVE8mPot3RaMQv5G6U7dQBy/rBz2Po9XMe9guoSzztU7H0E6vR2DUuKJcOI7RzaF8dBGPyH7hH6saI22/309tUH1s/LSpjXcWzKgi3NWnWKxDyPlmkvAo0NLiZX1rL0M1vrzmno43KRiCf5NmIzSYp/8WmELJBXFaIkWBZfxWKqQHa55nLLc06w+5W29c9AbvM9bO/1/5BZZdLRfF+lukyR1eL/by1sWPV4hBsS4gTX9/HUyZoAm7dTjxrIpy2fkDAPEh/7ebBwA0Su0GDKolw2/23GUHVaQro6f1JODw6caZLI56WEKP7AED78Mfosk1bYG9aEMGMQnNnBpcURwJlRMjSSP3krqUgYi9aN1JpeYlQ223StD08zxCdfDDkjnV3sz8JIWIcjZz04v6N6NNH2YyNzlS7vyYEC3/6YWZxu0xHlTmIkkDGQTnIq3CLAi/3oeSCxS2VMDiymBhtJAfq4wFf0CLeelauLX8thVY3mwwimEfALfxLE7MjCTdDwP0UVPWlFreLdV+3MLF/MnZk/mSSaT4+p4Pa05NoZVWI8m1Y2na3K9TPdEh9NMEAyKxYK/ltzHXRsGK34AxKIiM+J9x8UuQUTItsgkjD/A3og9vk8fKthj7UnvUkdBND3r0p3+xtEEQMJmhgw5Ye1jJwvO0PwQd7t0=
      on_success: always
      on_failure: never
      on_pull_requests: false
    -
      rooms:
        -
          secure: VJBoHxRWA3r9HifclAp+HwysQc3895CweEaIvP8VBxFwLFfXmcTBdJz0tCrDoPlHTiKXE7qRJ+QQVEiJst3bQ+PdRK8kE+4XAwC8A4qwXOP4C8Q8ZLYaBgVDTnbTw+IOTSTTNG+WDcO7Ln80EPNnURo1/xYxo5UrQZ82MxTtny1MvUpsv3sULtyvgAFf5tiT4XNiUXw4+4QFJazvg7WgyPIav7UVAPL6fLOyZpRCqBUr3jqh8HVdFZ1fPhS7UwrYv3cbU2fm0VCt4/kuVvn51xSJq2oqOJYriZ0Qvj+bXmINlH7GziLkdv5XydUxWKu/pQE6mb8E3NOhLVO0gEnXBYLHFnfMn2WiqERPVJl9ddQ4ap4mlXHGeEef0PcUn3BQWQW87WRSRw0uSIxQO7xlvBgC0G7FE9DVr7dTMHy/68SQRYSSk7fQJ98eUUtb3qC9ddFzh/GznGqLL343c92yNaovjpQUG0ZHxTSnrgalTIoq7O2BgZLdfuW8k0N20ilEkfYcnHvixI2DdpCCBtkz2z4EqG1ZM9GGqJrzumLvEo/2j+bC/MH6p0dymDdIPMso4Q2lW7lBg/jEdJf7Bfoxryti3UIZDQSCN1NUj5YA9CuCJa9Le2BIVSX0pg40KX4uWI2fh+44vjhCNa+zPhEdhaTe7G/PuHA0L9354kWwvSk=
      on_success: never
      on_failure: always
      on_pull_requests: false
